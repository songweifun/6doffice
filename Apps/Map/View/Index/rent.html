<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
    </style>
    <js file="__PUBLIC__/js/jquery.min.js"/>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=wFcr45UfFkvNP9kb3zyLn7xCv0pyEzxC"></script>
    <title>地图展示</title>
    <script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
    <link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css" />
    <script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
    <css file="__PUBLIC__/css/Map2_BaiduIndex.css"/>

</head>
<body>


<div id="allmap"></div>

</body>
</html>
<!--
<script src="http://api.map.baidu.com/geodata/v3/poi/list/?geotable_id=153394&ak='wFcr45UfFkvNP9kb3zyLn7xCv0pyEzxC'"></script>
-->
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");    // 创建Map实例
    map.centerAndZoom(new BMap.Point(116.404, 39.915), 14);  // 初始化地图,设置中心点坐标和地图级别
    map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
    map.setCurrentCity("南京");          // 设置地图显示的城市 此项是必须设置的
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    // 创建地址解析器实例
    var myGeo = new BMap.Geocoder();
    // 将地址解析结果显示在地图上,并调整地图视野
    myGeo.getPoint("南京市中山南路1号", function(point){
        if (point) {
            map.centerAndZoom(point, 14);
            //map.addOverlay(new BMap.Marker(point));
        }else{
            alert("您选择地址没有解析到结果!");
        }
    }, "南京市");

    /*//根据daboxId创建自定义图层，用户可用自己创建的geotableid替换30960
    var customLayer=new BMap.CustomLayer({
        geotableId: 153394,
        q: '', //检索关键字
        tags: '', //空格分隔的多字符串
        filter: '' //过滤条件,参考http://developer.baidu.com/map/lbs-geosearch.htm#.search.nearby
    });

    map.addTileLayer(customLayer);//添加自定义图层*/
    // 复杂的自定义覆盖物
    function ComplexCustomOverlay(point, text, mouseoverText){
        this._point = point;
        this._text = text;
        this._overText = mouseoverText;
    }
    ComplexCustomOverlay.prototype = new BMap.Overlay();
    ComplexCustomOverlay.prototype.initialize = function(map){
        this._map = map;
        var div = this._div = document.createElement("div");
        div.style.position = "absolute";
        div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat);
        div.style.backgroundColor = "#62AB00";
        div.style.border = "1px solid #81C15B";
        div.style.borderRadius = "5px";
        div.style.color = "white";
        div.style.height = "18px";
        div.style.padding = "2px";
        div.style.lineHeight = "18px";
        div.style.whiteSpace = "nowrap";
        div.style.MozUserSelect = "none";
        div.style.fontSize = "12px"
        var span = this._span = document.createElement("span");
        div.appendChild(span);
        span.appendChild(document.createTextNode(this._text));
        var that = this;

        var arrow = this._arrow = document.createElement("div");
        arrow.style.background = "url(http://map.baidu.com/fwmap/upload/r/map/fwmap/static/house/images/label.png) no-repeat";
        arrow.style.position = "absolute";
        arrow.style.width = "11px";
        arrow.style.height = "10px";
        arrow.style.top = "22px";
        arrow.style.left = "10px";
        arrow.style.overflow = "hidden";
        div.appendChild(arrow);

        div.onmouseover = function(){
            this.style.backgroundColor = "#FF7604";
            this.style.borderColor = "#FEB669";
            this.getElementsByTagName("span")[0].innerHTML = that._overText;
            arrow.style.backgroundPosition = "0px -20px";
        }

        div.onmouseout = function(){
            this.style.backgroundColor = "#62AB00";
            this.style.borderColor = "#81C15B";
            this.getElementsByTagName("span")[0].innerHTML = that._text;
            arrow.style.backgroundPosition = "0px 0px";
        }

        map.getPanes().labelPane.appendChild(div);

        return div;
    }
    ComplexCustomOverlay.prototype.draw = function(){
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._div.style.left = pixel.x - parseInt(this._arrow.style.left) + "px";
        this._div.style.top  = pixel.y - 30 + "px";
    }
    var txt = "银湖海岸城", mouseoverTxt = txt + " " + parseInt(Math.random() * 1000,10) + "套" ;



    var markers = [];
    var pt = null;

    function writeObj(obj){
        var description = "";
        for(var i in obj){
            var property=obj[i];
            description+=i+" = "+property+"\n";
        }
        alert(description);
    }
    /*$.ajax({
        url:"http://api.map.baidu.com/geodata/v3/poi/list?callback=?",
        data:{geotable_id :153394,ak:'wFcr45UfFkvNP9kb3zyLn7xCv0pyEzxC'},
        dataType:'json',
        type:'get',
        success:function(data){
            //alert(data.pois.location.length)
            for(var i=0;i<data.length;i++){
                //alert(data[i].pois.location)
                pt = new BMap.Point(data[i].pois.location);
                markers.push(new BMap.Marker(pt));
            }

            var markerClusterer = new BMapLib.MarkerClusterer(map, {markers:markers});

        }

    })
*/

    /*var MAX = 10;
    var i = 0;
    for (; i < MAX; i++) {
        pt = new BMap.Point(Math.random() * 40 + 85, Math.random() * 30 + 21);
        markers.push(new BMap.Marker(pt));

    }*/
   var url="<!--{:U(MODULE_NAME.'/Index/marker')}-->";
    //alert(url)
    $.ajax({
        url:url,
        dataType:'json',
        type:'post',
        success:function(data){
            //alert(data.pois.location.length)
            for(var i=0;i<data.length;i++){
                //alert(data[i].lat)
                pt = new BMap.Point(data[i].lng,data[i].lat);
                var marke=new BMap.Marker(pt)
                marke.hide()
                var myCompOverlay = new ComplexCustomOverlay(pt, "银湖海岸城",mouseoverTxt);

                map.addOverlay(myCompOverlay);
                marke.bid=data[i].id
                marke.address=data[i].borough_address
                marke.name=data[i].borough_name
                markers.push(marke);
            }
            //var markerClusterer = new BMapLib.MarkerClusterer(map, {markers:markers});

            for (var j=0;j<markers.length;j++){//添加事件

                doclick(markers[j])
            }
        }

    })

    var sContent =
            "<h4 style='margin:0 0 5px 0;padding:0.2em 0'>天安门</h4>" +
            "<img style='float:right;margin:4px' id='imgDemo' src='http://app.baidu.com/map/images/tiananmen.jpg' width='139' height='104' title='天安门'/>" +
            "<p style='margin:0;line-height:1.5;font-size:13px;text-indent:2em'>天安门坐落在中国北京市中心,故宫的南侧,与天安门广场隔长安街相望,是清朝皇城的大门...</p>" +
            "</div>";
    function doclick(maj){//为避免执行一次外部执行添加事件
        maj.onclick=function(){

            //alert(maj.bid)
            var content = '<p style="width:280px;margin:0;line-height:20px;">地址：' + maj.address +  '</p>';
           var searchInfoWindow = new BMapLib.SearchInfoWindow(map, content, {  //带检索的信息窗口
             title: maj.name, //标题
             width: 290, //宽度
             height: 40, //高度
             panel : "panel", //检索结果面板
             enableAutoPan : true, //自动平移
             enableSendToPhone: true, //是否显示发送到手机按钮
             searchTypes :[
             BMAPLIB_TAB_SEARCH,   //周边检索
             BMAPLIB_TAB_TO_HERE,  //到这里去
             BMAPLIB_TAB_FROM_HERE //从这里出发
             ]
             });

            searchInfoWindow.open(this);
             //alert(maj.bid)
            /*var infoWindow = new BMap.InfoWindow(sContent);  // 创建信息窗口对象
            this.openInfoWindow(infoWindow);*/

        }
    }

    //customLayer.addEventListener('onhotspotclick',callback);//单击图层事件
    function callback(e)//单击热点图层
    {
        var customPoi = e.customPoi,  //获取poi对象
                str = [];
        str.push("address = " + customPoi.address);
        //str.push("phoneNumber = " + customPoi.phoneNumber);
        var content = '<p style="width:280px;margin:0;line-height:20px;">地址：' + customPoi.address +  '</p>';
        var searchInfoWindow = new BMapLib.SearchInfoWindow(map, content, {  //带检索的信息窗口
            title: customPoi.title, //标题
            width: 290, //宽度
            height: 40, //高度
            panel : "panel", //检索结果面板
            enableAutoPan : true, //自动平移
            enableSendToPhone: true, //是否显示发送到手机按钮
            searchTypes :[
                BMAPLIB_TAB_SEARCH,   //周边检索
                BMAPLIB_TAB_TO_HERE,  //到这里去
                BMAPLIB_TAB_FROM_HERE //从这里出发
            ]
        });
        var point = new BMap.Point(customPoi.point.lng, customPoi.point.lat);
        searchInfoWindow.open(point);

    }
</script>